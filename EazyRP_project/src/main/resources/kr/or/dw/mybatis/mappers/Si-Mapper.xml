<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.dw.dao.SiDAO">

<sql id="search">
		<if test="searchType == 'd'.toString()">
			AND e_name LIKE '%' || #{keyword} || '%'
		</if>
		<if test="searchType == 't'.toString()">
			AND wh_name LIKE '%' || #{keyword} || '%'
		</if>
		<if test="searchType == 'p'.toString()">
			AND progress LIKE '%' || #{keyword} || '%'
		</if>
		<if test="searchType == 'w'.toString()">
			AND pr_name LIKE '%' || #{keyword} || '%'
		</if>
		<if test="searchType == 'all'.toString()">
			AND (
			e_name LIKE '%' || #{keyword} || '%'
			OR
			wh_name LIKE '%' || #{keyword} || '%'
			OR
			progress LIKE '%' || #{keyword} || '%'
			OR
			pr_name LIKE '%' || #{keyword} || '%'
			)
		</if>
	</sql>

<sql id="siSeq">
SELECT ('SI_') || CASE 
						WHEN LENGTH(si_seq.currval) = 1
						THEN '00' || si_seq.currval
						WHEN LENGTH(si_seq.currval) = 2
						THEN '0' || si_seq.currval
						ELSE '' || si_seq.currval
			   	 END SI_NO
	  FROM dual

</sql>


<select id="selectSiList" resultType="Map">
SELECT s2.SI_NO,
	 MAX((SELECT wh_name FROM WAREHOUSE WHERE wh_no = s2.WH_NO)) wh_name
	,MAX((SELECT e_name FROM EMP WHERE emp_no = s2.EMP_NO)) e_name
	,MAX(e.SYS_REGDATE) SYS_REGDATE
	,CASE WHEN count(s2.PR_NO) <![CDATA[ > ]]> 1
		  		THEN MAX((SELECT pr_name FROM product WHERE pr_no = s2.pr_no)) || ' 외 ' || (count(s2.PR_NO)-1)  || '건'
		  		ELSE MAX((SELECT pr_name FROM product WHERE pr_no = s2.pr_no))
	END pr_name
	,MAX(s2.PROGRESS) progress
  FROM si s, emp e, warehouse w, fc f ,product p ,SIDETAIL s2 
 WHERE s2.emp_no = e.emp_no
  AND s2.wh_no = w.wh_no
  AND s2.fc_no = f.fc_no
  AND s2.pr_no = p.pr_no
  AND s.SI_NO = s2.SI_NO
    <include refid="search"/>
  GROUP BY s2.SI_NO
  ORDER BY s2.SI_NO desc
</select>
	
<select id="selectSearchSiListCount" resultType="int">
	SELECT COUNT(*)
	FROM si s, emp e, warehouse w, fc f, product p, sidetail s2
	 WHERE 1=1 
   AND s2.emp_no = e.emp_no
   AND s2.wh_no = w.wh_no
   AND s2.fc_no = f.fc_no
   AND s2.pr_no = p.pr_no
   AND s2.si_no = s.si_no
	<include refid="search"/>
</select>	
	

<select id="selectSiDetail" resultType="Map">
	SELECT s2.si_no
	  ,s.sys_regdate 
	  ,e.e_name e_name
	  ,s2.shipdate 
	  ,s2.progress 
	  ,s2.enabled 
	  ,w.wh_name wh_name
	  ,s2.quantity 
	  ,s2.files 
	  ,f.fc_name fc_name
	  ,s.sys_up 
	  ,s.sys_updatedate 
	  ,p.pr_name pr_name
	  ,e.emp_no
	  ,f.fc_no
	  ,p.pr_no 
  FROM si s, emp e, warehouse w, fc f ,product p ,SIDETAIL s2 
 WHERE s2.emp_no = e.emp_no
   AND s2.wh_no = w.wh_no
   AND s2.fc_no = f.fc_no
   AND s2.pr_no = p.pr_no
   AND s.SI_NO = s2.SI_NO
   AND s2.SI_NO = #{SI_NO}
</select>	
	
	
<select id="forSiList" resultType="Map">
 SELECT ROWNUM,s2.SI_NO ,w.WH_NAME, e.E_NAME ,s.SYS_REGDATE ,s2.SHIPDATE 
   ,s2.QUANTITY ,s.SYS_UP ,p.PR_NO ,p.PR_NAME,s2.SIDETAIL_NO
   FROM SI s , WAREHOUSE w ,EMP e,SIDETAIL s2 , product p  
   WHERE s2.WH_NO = w.WH_NO 
   AND s2.EMP_NO = e.EMP_NO 
   AND s.SI_NO = s2.SI_NO 
   AND s2.pr_no = p.pr_no
   AND s2.SI_NO = #{SI_NO}
 </select>
	
<select id="ename" resultType="str">
	SELECT e_name
	FROM emp
	WHERE emp_no = #{empno}
</select>	
	
	
</mapper>